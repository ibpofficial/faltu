<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Faltu Chat Self-Destruct</title>
    
    <!-- 1. Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- 2. Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'bounce-slight': 'bounce 1s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            overscroll-behavior-y: none;
        }
        .h-dvh { height: 100dvh; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="bg-[#020617] h-dvh w-screen overflow-hidden text-slate-100 selection:bg-indigo-500/40">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, deleteDoc, query, where, getDocs, writeBatch, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION
        // ==========================================
        let firebaseConfig = {
            apiKey: "AIzaSyDYUW7qKEQzY5wznDhS9RXRqjTiVyWqacg",
            authDomain: "chat-fixed.firebaseapp.com",
            projectId: "chat-fixed",
            storageBucket: "chat-fixed.firebasestorage.app",
            messagingSenderId: "616897912392",
            appId: "1:616897912392:web:bb6729b053d6e0d840827d"
        };
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) firebaseConfig = JSON.parse(__firebase_config); } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { useState, useEffect, useRef } = React;

        // --- Utils ---
        const getAvatarColor = (name) => {
            const colors = ['bg-pink-500', 'bg-rose-500', 'bg-orange-500', 'bg-amber-500', 'bg-emerald-500', 'bg-teal-500', 'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        const Linkify = ({ text }) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const parts = text.split(urlRegex);
            return (<span>{parts.map((part, i) => part.match(urlRegex) ? <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-indigo-300 font-semibold hover:underline break-all">{part}</a> : part)}</span>);
        };

        const isBigEmoji = (text) => {
            const emojiRegex = /^(\p{Emoji_Presentation}|\p{Extended_Pictographic}){1,3}$/u;
            return emojiRegex.test(text.trim());
        };

        // Aggressive Compression for Database
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500; // Smaller size for quick loading
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); // 60% quality
                    }
                }
            });
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Components ---
        const SelfDestructTimer = ({ createdAt, onDelete }) => {
            const [timeLeft, setTimeLeft] = useState(60);

            useEffect(() => {
                if (!createdAt) return;
                const interval = setInterval(() => {
                    const secondsAlive = (Date.now() - createdAt.seconds * 1000) / 1000;
                    const remaining = Math.max(0, 60 - secondsAlive);
                    setTimeLeft(Math.floor(remaining));
                    
                    if (remaining <= 0) {
                        onDelete(); // Trigger deletion locally if expired
                        clearInterval(interval);
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, [createdAt]);

            if (timeLeft <= 0) return null;

            return (
                <div className="absolute bottom-2 right-2 bg-black/70 backdrop-blur text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-red-500/50 animate-pulse-fast">
                    <Icon name="bomb" size={12} className="text-red-500" /> {timeLeft}s
                </div>
            );
        };

        function App() {
            // Core
            const [user, setUser] = useState(null);
            const [screen, setScreen] = useState('home'); 
            const [username, setUsername] = useState(localStorage.getItem('faltu_username') || '');
            const [roomId, setRoomId] = useState('');
            const [savedRooms, setSavedRooms] = useState(() => JSON.parse(localStorage.getItem('faltu_saved_rooms') || '[]'));
            const [messages, setMessages] = useState([]);
            
            // Features
            const [newMessage, setNewMessage] = useState('');
            const [replyingTo, setReplyingTo] = useState(null);
            const [typingUsers, setTypingUsers] = useState([]);
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [showUserList, setShowUserList] = useState(false);
            const [showEmojis, setShowEmojis] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            
            // Refs
            const messagesEndRef = useRef(null);
            const lastTypingUpdate = useRef(0);
            const fileInputRef = useRef(null);
            const receiveSound = useRef(new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3'));
            const sendSound = useRef(new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'));

            const EMOJIS = ["ðŸ‘", "â¤ï¸", "ðŸ˜‚", "ðŸ˜®", "ðŸ˜¢", "ðŸ˜¡", "ðŸ”¥", "ðŸŽ‰", "ðŸ‘‹", "âœ…", "ðŸ‘€", "âœ¨", "ðŸ’€", "ðŸ’©", "ðŸ‘»", "ðŸ¤–"];

            // 1. Auth & Install
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            useEffect(() => {
                const initAuth = async () => {
                    try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } 
                    catch (e) { await signInAnonymously(auth); }
                };
                initAuth();
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                localStorage.setItem('faltu_username', username);
                localStorage.setItem('faltu_saved_rooms', JSON.stringify(savedRooms));
            }, [username, savedRooms]);

            // 2. Chat Logic & CLEANER
            useEffect(() => {
                if (!user || screen !== 'chat' || !roomId) return;

                // A. THE CLEANER: Deletes images older than 60s
                const cleanerInterval = setInterval(async () => {
                    const now = Date.now();
                    // We check loaded messages first to save reads
                    messages.forEach(async (msg) => {
                        if (msg.type === 'image' && msg.createdAt) {
                            const age = now - (msg.createdAt.seconds * 1000);
                            if (age > 60000) { // 60 seconds
                                try { await deleteDoc(doc(db, 'chat_messages', msg.id)); } catch(e) {}
                            }
                        }
                    });
                }, 5000); // Check every 5 seconds

                // B. Listen for Messages
                const unsubMsg = onSnapshot(collection(db, 'chat_messages'), (snap) => {
                    let playReceive = false;
                    snap.docChanges().forEach(c => {
                        if(c.type === 'added' && c.doc.data().roomId === roomId && c.doc.data().uid !== user.uid) {
                             const data = c.doc.data();
                             if (data.createdAt && (Date.now() - data.createdAt.toMillis() < 2000)) playReceive = true;
                        }
                    });
                    
                    if(playReceive && !document.hidden) receiveSound.current.play().catch(()=>{});

                    const msgs = snap.docs
                        .map(d=>({id:d.id, ...d.data()}))
                        .filter(m=>m.roomId===roomId)
                        .sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
                        
                    setMessages(msgs.slice(-50));
                    setTimeout(() => window.lucide?.createIcons(), 100);
                });

                // C. Presence & Typing
                const updatePres = () => setDoc(doc(db, 'room_users', `${roomId}_${user.uid}`), { uid:user.uid, displayName:username, roomId, lastSeen:serverTimestamp() }).catch(()=>{});
                updatePres();
                const intPres = setInterval(updatePres, 60000);
                const unsubPres = onSnapshot(collection(db, 'room_users'), (s) => setOnlineUsers(s.docs.map(d=>d.data()).filter(d=>d.roomId===roomId && d.lastSeen && (Date.now()-d.lastSeen.toMillis()<120000))));
                const unsubType = onSnapshot(collection(db, 'typing_status'), (s) => setTypingUsers(s.docs.map(d=>d.data()).filter(d=>d.roomId===roomId && d.uid!==user.uid && (Date.now()-d.timestamp<3000)).map(d=>d.displayName)));

                return () => { unsubMsg(); unsubPres(); unsubType(); clearInterval(intPres); clearInterval(cleanerInterval); };
            }, [user, screen, roomId, messages]); // added messages dep for cleaner

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, typingUsers, replyingTo, isUploading]);

            // --- Handlers ---
            const handleJoin = (targetRoomId) => {
                if(!username) { alert("Set username first!"); return; }
                const rId = targetRoomId || roomId;
                if(!rId) return;
                setRoomId(rId);
                setScreen('chat');
            };

            const toggleSaveRoom = () => {
                const exists = savedRooms.find(r => r.id === roomId);
                if (exists) setSavedRooms(savedRooms.filter(r => r.id !== roomId));
                else setSavedRooms([...savedRooms, { id: roomId, name: roomId }]);
            };

            const handleSendMessage = async (e) => {
                if(e) e.preventDefault();
                if (!newMessage.trim()) return;
                sendSound.current.currentTime = 0; sendSound.current.play().catch(()=>{});
                try {
                    await addDoc(collection(db, 'chat_messages'), {
                        text: newMessage, uid: user.uid, displayName: username, roomId, createdAt: serverTimestamp(), type: 'text',
                        replyTo: replyingTo ? { id: replyingTo.id, displayName: replyingTo.displayName, text: replyingTo.text } : null
                    });
                    setNewMessage(''); setReplyingTo(null); setShowEmojis(false);
                } catch (err) {}
            };

            const handleImageSelect = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5 * 1024 * 1024) { alert("Image too large. Max 5MB."); return; }
                
                setIsUploading(true);
                try {
                    const compressedBase64 = await compressImage(file);
                    await addDoc(collection(db, 'chat_messages'), {
                        text: "Sent an image", 
                        imageUrl: compressedBase64,
                        type: 'image',
                        uid: user.uid, displayName: username, roomId, createdAt: serverTimestamp(),
                        replyTo: replyingTo ? { id: replyingTo.id, displayName: replyingTo.displayName, text: replyingTo.text } : null
                    });
                    sendSound.current.play().catch(()=>{});
                    setReplyingTo(null);
                } catch (err) { alert("Failed to send image."); } 
                finally { setIsUploading(false); e.target.value = null; }
            };

            const handleDelete = async (msgId) => {
                if(confirm("Delete this?")) await deleteDoc(doc(db, 'chat_messages', msgId));
            };

            const handleTyping = (e) => {
                setNewMessage(e.target.value);
                if (Date.now() - lastTypingUpdate.current > 2000) {
                    lastTypingUpdate.current = Date.now();
                    setDoc(doc(db, 'typing_status', user.uid), { uid: user.uid, displayName: username, roomId, timestamp: Date.now() }).catch(()=>{});
                }
            };

            const installApp = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setDeferredPrompt(null);
                } else { alert("To install: Tap 'Share' > 'Add to Home Screen' (iOS) or use Chrome menu (Android)."); }
            };

            // --- RENDER ---

            if (screen === 'home') {
                return (
                    <div className="flex flex-col h-dvh bg-[#020617] relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-80 h-80 bg-indigo-600/10 rounded-full blur-[80px] animate-float"></div>
                        <div className="absolute bottom-0 left-0 w-80 h-80 bg-purple-600/10 rounded-full blur-[80px] animate-float" style={{animationDelay: '2s'}}></div>
                        <div className="flex-1 flex flex-col p-6 max-w-md mx-auto w-full z-10 overflow-y-auto">
                            <div className="mt-8 mb-8 text-center">
                                <h1 className="text-5xl font-black text-white tracking-tighter mb-1" style={{textShadow: '0 0 30px rgba(99, 102, 241, 0.4)'}}>Faltu.</h1>
                                <p className="text-indigo-300/80 text-xs font-bold tracking-[0.2em] uppercase">Self-Destruct Mode</p>
                            </div>
                            <div className="bg-slate-900/40 backdrop-blur-md p-5 rounded-[28px] border border-slate-800 mb-6 shadow-xl">
                                <label className="text-[10px] text-indigo-400 font-black uppercase mb-2 block tracking-wider ml-1">Identity</label>
                                <div className="flex gap-3 items-center">
                                    <div className="bg-slate-800 p-2.5 rounded-xl text-indigo-400"><Icon name="user" size={20} /></div>
                                    <input type="text" value={username} onChange={e => setUsername(e.target.value)} placeholder="Username"
                                        className="flex-1 bg-transparent border-b-2 border-slate-700 focus:border-indigo-500 text-white text-lg font-bold px-1 py-1 outline-none transition-colors placeholder-slate-600" />
                                </div>
                            </div>
                            <button onClick={installApp} className="mb-8 w-full py-3 bg-slate-800/50 hover:bg-slate-800 border border-slate-700 text-slate-300 font-bold rounded-2xl flex items-center justify-center gap-2 text-sm transition-all"><Icon name="download" size={16} /> {deferredPrompt ? "Install App" : "Add to Home Screen"}</button>
                            <div className="flex items-center justify-between mb-4 px-2"><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Saved Rooms</h2></div>
                            <div className="flex-1 space-y-3 pb-20">
                                {savedRooms.length === 0 ? <div className="text-center py-12 border-2 border-dashed border-slate-800/50 rounded-[32px] text-slate-600"><Icon name="star" size={28} className="mx-auto mb-3 opacity-20" /><p className="text-sm font-medium opacity-60">No favorites yet</p></div> : savedRooms.map(r => (
                                    <div key={r.id} onClick={() => handleJoin(r.id)} className="bg-slate-900/60 backdrop-blur-sm p-4 rounded-[24px] flex items-center justify-between cursor-pointer border border-slate-800/60 hover:border-indigo-500/30 hover:bg-slate-800 active:scale-[0.98] transition-all group">
                                        <div className="flex items-center gap-4"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-bold text-xl text-white shadow-md ${getAvatarColor(r.id)}`}>{r.id.charAt(0)}</div><div><h3 className="font-bold text-slate-100">{r.name}</h3><p className="text-xs text-slate-500 group-hover:text-indigo-400 transition-colors">Tap to enter</p></div></div>
                                        <button onClick={(e) => { e.stopPropagation(); setSavedRooms(savedRooms.filter(x => x.id !== r.id)); }} className="p-3 text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded-xl transition-all"><Icon name="trash-2" size={18} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="absolute bottom-6 left-0 right-0 px-6 max-w-md mx-auto z-20">
                            <button onClick={() => setScreen('join')} className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-[24px] shadow-lg shadow-indigo-900/40 active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-lg"><Icon name="plus" strokeWidth={3} size={20} /> Start New Chat</button>
                        </div>
                    </div>
                );
            }

            if (screen === 'join') {
                return (
                    <div className="flex flex-col h-dvh bg-[#020617] items-center justify-center p-6 relative">
                         <div className="w-full max-w-md bg-slate-900/90 backdrop-blur-xl p-8 rounded-[40px] border border-slate-800 shadow-2xl z-10 fade-in">
                            <button onClick={() => setScreen('home')} className="mb-8 text-slate-400 hover:text-white flex items-center gap-2 text-xs font-bold bg-slate-800/50 px-3 py-2 rounded-full w-fit transition-colors"><Icon name="arrow-left" size={14} /> HOME</button>
                            <h2 className="text-3xl font-black mb-2 text-white">Join Room</h2>
                            <div className="space-y-4 mb-8 mt-8">
                                <div className="bg-black/20 border border-slate-700 rounded-2xl p-2 flex items-center focus-within:border-indigo-500 transition-colors">
                                    <div className="pl-4 text-slate-500"><Icon name="hash" /></div>
                                    <input type="text" value={roomId} onChange={e => setRoomId(e.target.value)} placeholder="SECRET_CODE" className="flex-1 bg-transparent px-3 py-4 outline-none text-xl font-bold text-white placeholder-slate-700 tracking-wide uppercase" />
                                </div>
                                <button onClick={() => setRoomId(Math.random().toString(36).substring(2, 7).toUpperCase())} className="w-full py-3 bg-slate-800 hover:bg-slate-700 rounded-2xl font-bold text-indigo-400 text-xs flex items-center justify-center gap-2 transition-colors"><Icon name="shuffle" size={14} /> RANDOM</button>
                            </div>
                            <button onClick={() => handleJoin()} className="w-full bg-white text-black py-4 rounded-[24px] font-black text-lg shadow-lg active:scale-[0.98] transition-all">ENTER</button>
                        </div>
                    </div>
                );
            }

            const isSaved = savedRooms.some(r => r.id === roomId);
            return (
                <div className="flex flex-col h-dvh bg-[#0f172a] font-sans max-w-md mx-auto shadow-2xl relative border-x border-slate-800/50">
                    <header className="bg-slate-900/95 backdrop-blur-md p-3 flex items-center justify-between border-b border-slate-800 z-30 sticky top-0 safe-top">
                        <div className="flex items-center gap-3 cursor-pointer overflow-hidden" onClick={() => setShowUserList(!showUserList)}>
                            <button className="bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white transition-colors flex-shrink-0" onClick={(e) => { e.stopPropagation(); setScreen('home'); }}><Icon name="arrow-left" size={20} /></button>
                            <div className="min-w-0">
                                <h2 className="font-bold text-lg leading-none flex items-center gap-2 text-white mb-1 truncate">
                                    {roomId}
                                    <button onClick={(e) => { e.stopPropagation(); toggleSaveRoom(); }} className={`transition-transform active:scale-125 ${isSaved ? 'text-amber-400' : 'text-slate-600'}`}><Icon name="star" size={16} fill={isSaved ? "currentColor" : "none"} /></button>
                                </h2>
                                <p className="text-[10px] text-emerald-400 font-bold tracking-wide flex items-center gap-1"><span className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span> {onlineUsers.length} Online</p>
                            </div>
                        </div>
                        <button onClick={() => navigator.clipboard.writeText(roomId)} className="bg-slate-800 p-2.5 rounded-xl text-slate-400 hover:text-white active:scale-95 transition-all"><Icon name="copy" size={18} /></button>
                    </header>
                    
                    {showUserList && <div className="absolute top-[72px] left-4 right-4 bg-slate-800/95 backdrop-blur-xl p-4 z-40 rounded-2xl border border-slate-700 shadow-2xl fade-in"><div className="flex flex-wrap gap-2">{onlineUsers.map((u,i)=>(<span key={i} className="text-xs bg-slate-700/80 px-3 py-1.5 rounded-lg text-slate-200 font-bold flex items-center gap-2"><span className="w-1.5 h-1.5 bg-emerald-400 rounded-full"></span>{u.displayName}</span>))}</div></div>}

                    <main className="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-950 scroll-smooth" onClick={() => { setShowUserList(false); setShowEmojis(false); }}>
                        {messages.length === 0 && <div className="text-center mt-32 opacity-30"><Icon name="message-circle" size={64} className="mx-auto mb-4"/><p className="text-lg font-bold">Start the conversation</p></div>}
                        
                        {messages.map((msg, i) => {
                            const isMe = msg.uid === user?.uid;
                            const showHeader = i === 0 || messages[i-1].uid !== msg.uid;
                            const bigEmoji = isBigEmoji(msg.text || "");
                            
                            return (
                                <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} ${showHeader ? 'mt-6' : 'mt-1'} fade-in group relative`}>
                                    {!isMe && showHeader && <div className={`w-8 h-8 rounded-xl flex-shrink-0 flex items-center justify-center text-xs font-bold mr-2 mt-1 text-white shadow-md ${getAvatarColor(msg.displayName)}`}>{msg.displayName.charAt(0).toUpperCase()}</div>}
                                    {!isMe && !showHeader && <div className="w-8 mr-2"></div>}
                                    
                                    <div className={`flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[85%]`}>
                                        {showHeader && !isMe && <span className="text-[10px] text-slate-400 ml-1 mb-1 font-bold">{msg.displayName}</span>}
                                        
                                        <div className={`relative px-4 py-3 text-[15px] shadow-sm break-words leading-relaxed transition-all
                                            ${bigEmoji ? 'bg-transparent shadow-none p-0' : (isMe ? 'bg-indigo-600 text-white rounded-[20px] rounded-tr-sm' : 'bg-[#1e293b] text-slate-100 rounded-[20px] rounded-tl-sm border border-slate-800')}`}>
                                            
                                            {msg.replyTo && !bigEmoji && (
                                                <div className={`mb-2 rounded-lg p-2 text-xs border-l-[3px] ${isMe ? 'bg-indigo-800/40 border-indigo-300/50' : 'bg-slate-900/40 border-slate-600'}`}><p className="font-bold opacity-90 mb-0.5">{msg.replyTo.displayName}</p><p className="truncate opacity-70 italic">{msg.replyTo.text}</p></div>
                                            )}
                                            
                                            {msg.type === 'image' ? (
                                                <div className="relative rounded-lg overflow-hidden mb-1 border border-slate-700">
                                                    <img src={msg.imageUrl} alt="Self-destructing" className="max-w-full max-h-64 object-cover rounded-lg" loading="lazy" />
                                                    <SelfDestructTimer createdAt={msg.createdAt} onDelete={() => handleDelete(msg.id)} />
                                                </div>
                                            ) : (
                                                <div className={bigEmoji ? "text-6xl animate-bounce-slight" : "whitespace-pre-wrap"}><Linkify text={msg.text} /></div>
                                            )}
                                            
                                            {!bigEmoji && msg.type !== 'image' && (
                                                <div className="flex items-center gap-2 justify-end mt-1 opacity-60"><span className="text-[10px] font-bold">{msg.createdAt ? new Date(msg.createdAt.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}</span>{isMe && <button onClick={(e) => { e.stopPropagation(); handleDelete(msg.id); }} className="p-1 text-red-200 hover:bg-red-500/20 rounded-full"><Icon name="trash-2" size={10} /></button>}</div>
                                            )}
                                            
                                            <button onClick={()=>setReplyingTo(msg)} className={`absolute top-0 bottom-0 ${isMe?'-left-12':'-right-12'} p-3 rounded-full text-slate-500 opacity-0 group-hover:opacity-100 hover:text-indigo-400 transition-all`}><Icon name="reply" size={20}/></button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        {isUploading && <div className="fade-in ml-12 text-xs font-bold text-indigo-400 flex items-center gap-2"><Icon name="loader-2" size={12} className="animate-spin" /> Encrypting Image...</div>}
                        {typingUsers.length > 0 && <div className="fade-in ml-12 text-xs font-bold text-indigo-400 flex items-center gap-2"><span className="flex gap-1"><span className="w-1 h-1 bg-indigo-500 rounded-full animate-bounce"></span><span className="w-1 h-1 bg-indigo-500 rounded-full animate-bounce delay-100"></span><span className="w-1 h-1 bg-indigo-500 rounded-full animate-bounce delay-200"></span></span> {typingUsers.join(", ")} is typing...</div>}
                        <div ref={messagesEndRef} />
                    </main>

                    <div className="bg-slate-900 border-t border-slate-800 z-30 pb-safe">
                        {replyingTo && <div className="bg-slate-800/50 p-2 border-l-4 border-indigo-500 flex justify-between items-center mx-2 mt-2 rounded-r-lg slide-up"><div className="text-xs text-slate-300 ml-2"><span className="font-bold text-indigo-400 block mb-0.5 uppercase">Replying to {replyingTo.displayName}</span> <span className="opacity-70 line-clamp-1">{replyingTo.text}</span></div><button onClick={()=>setReplyingTo(null)} className="p-2 hover:bg-slate-700 rounded-full"><Icon name="x" size={16}/></button></div>}
                        
                        {showEmojis && <div className="flex gap-2 p-2 px-4 overflow-x-auto bg-slate-950/50 slide-up border-b border-slate-800 no-scrollbar">{EMOJIS.map(e => <button key={e} onClick={() => setNewMessage(p => p + e)} className="text-2xl hover:bg-slate-800 p-2 rounded-xl transition-colors">{e}</button>)}</div>}

                        <footer className="p-3">
                            <form onSubmit={handleSendMessage} className="flex gap-2 bg-[#1e293b] p-1.5 rounded-[28px] border border-slate-700 focus-within:border-indigo-500 focus-within:ring-1 focus-within:ring-indigo-500/30 transition-all shadow-lg items-end">
                                <button type="button" onClick={() => setShowEmojis(!showEmojis)} className={`p-3 rounded-full text-slate-400 hover:text-yellow-400 hover:bg-slate-800 transition-all ${showEmojis ? 'text-yellow-400 bg-slate-800' : ''}`}><Icon name="smile" size={20} /></button>
                                <button type="button" onClick={() => fileInputRef.current?.click()} className="p-3 rounded-full text-slate-400 hover:text-red-400 hover:bg-slate-800 transition-all"><Icon name="camera" size={20} /></button>
                                <input type="file" ref={fileInputRef} onChange={handleImageSelect} accept="image/*" className="hidden" />
                                <textarea value={newMessage} onChange={handleTyping} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } }} placeholder="Message..." className="flex-1 bg-transparent text-white px-2 py-3 outline-none text-[16px] font-medium placeholder-slate-500 min-w-0 resize-none max-h-24" rows={1} />
                                <button disabled={!newMessage.trim()} className="bg-indigo-600 text-white w-11 h-11 rounded-full hover:bg-indigo-500 shadow-md active:scale-95 transition-all disabled:opacity-50 disabled:scale-100 flex items-center justify-center flex-shrink-0 mb-0.5"><Icon name="send" size={20} className={newMessage.trim() ? 'ml-0.5' : ''}/></button>
                            </form>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

