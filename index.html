<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickChat Room</title>
    
    <!-- 1. Load Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Load Babel (To understand the code in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-100 h-screen w-screen overflow-hidden">

    <div id="root"></div>

    <!-- 5. The Application Code -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // ==========================================
        // CONFIGURATION SECTION
        // ==========================================
        
        // 1. FOR GITHUB / PUBLIC HOSTING:
        // Replace the values below with your own keys from the Firebase Console.
       const firebaseConfig = {
  apiKey: "AIzaSyDYUW7qKEQzY5wznDhS9RXRqjTiVyWqacg",
  authDomain: "chat-fixed.firebaseapp.com",
  projectId: "chat-fixed",
  storageBucket: "chat-fixed.firebasestorage.app",
  messagingSenderId: "616897912392",
  appId: "1:616897912392:web:bb6729b053d6e0d840827d"
};

        // 2. FOR THIS PREVIEW WINDOW ONLY:
        // This block tries to load the environment's internal config so the app works 
        // right now while you are testing it here.
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.log("Running in manual mode (no internal config found)");
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ==========================================

        // Initialize Firebase
        let app, auth, db;
        let configError = null;

        try {
            // Check if config is still default placeholder
            if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                throw new Error("Firebase not configured");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            configError = e.message;
        }

        const { useState, useEffect, useRef } = React;

        // --- Icon Component Wrappers ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const [screen, setScreen] = useState('join');
            const [username, setUsername] = useState('');
            const [roomId, setRoomId] = useState('');
            
            const messagesEndRef = useRef(null);

            useEffect(() => {
                // If we detected a config error earlier (e.g. still using placeholders), stop here.
                if (configError) {
                    setError("Firebase API Key is missing. Please open the code file and paste your Firebase Config keys where indicated.");
                    setLoading(false);
                    return;
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error", err);
                        setError("Could not sign in: " + err.message);
                        setLoading(false);
                    }
                };
                
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || screen !== 'chat' || !roomId || !db) return;

                // RULE 1: Use strict public path
                const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');

                const unsubscribe = onSnapshot(messagesRef, (snapshot) => {
                    const loadedMessages = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(msg => msg.roomId === roomId) // Client-side filtering
                        .sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                    setMessages(loadedMessages);
                    setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 100);
                });

                return () => unsubscribe();
            }, [user, screen, roomId]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                if(window.lucide) window.lucide.createIcons();
            }, [messages, screen]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !user) return;

                try {
                    const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
                    await addDoc(messagesRef, {
                        text: newMessage,
                        uid: user.uid,
                        displayName: username,
                        roomId: roomId,
                        createdAt: serverTimestamp()
                    });
                    setNewMessage('');
                } catch (err) {
                    console.error("Error sending", err);
                    alert("Error sending message. Check console.");
                }
            };

            const generateRoomId = () => {
                setRoomId(Math.random().toString(36).substring(2, 8).toUpperCase());
            };

            const handleJoin = (e) => {
                e.preventDefault();
                if(username && roomId) setScreen('chat');
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-slate-50">
                     <div className="text-blue-500 flex flex-col items-center gap-2">
                        <span className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></span>
                        Loading...
                    </div>
                </div>
            );
            
            if (error) return (
                <div className="h-screen flex flex-col items-center justify-center bg-red-50 p-6 text-center">
                    <div className="bg-white p-6 rounded-xl shadow-lg max-w-md">
                        <h3 className="text-red-600 font-bold text-lg mb-2">Configuration Error</h3>
                        <p className="text-gray-600 mb-4">{error}</p>
                        <p className="text-xs text-gray-400">If you are the developer, edit the index.html file and update the firebaseConfig object.</p>
                    </div>
                </div>
            );

            // --- JOIN SCREEN ---
            if (screen === 'join') {
                return (
                    <div className="flex flex-col h-screen bg-gradient-to-br from-blue-500 to-purple-600 items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold text-gray-800">QuickChat</h1>
                                <p className="text-gray-500 text-sm">Real-time secure messaging</p>
                            </div>
                            <form onSubmit={handleJoin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                                    <input type="text" required value={username} onChange={e => setUsername(e.target.value)}
                                        className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="e.g. Alex" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Room ID</label>
                                    <div className="flex gap-2">
                                        <input type="text" required value={roomId} onChange={e => setRoomId(e.target.value)}
                                            className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="e.g. ROOM1" />
                                        <button type="button" onClick={generateRoomId} className="px-3 bg-gray-100 hover:bg-gray-200 rounded-xl text-xs font-bold transition-colors">RND</button>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1">Share this ID with friends to chat.</p>
                                </div>
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg mt-4 transition-all transform active:scale-95">Enter Room</button>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- CHAT SCREEN ---
            return (
                <div className="flex flex-col h-screen bg-slate-100 font-sans max-w-md mx-auto shadow-2xl relative">
                    <header className="bg-white p-4 flex items-center justify-between shadow-sm z-10 border-b">
                        <div>
                            <h2 className="font-bold text-gray-800">Room: {roomId}</h2>
                            <span className="text-xs text-green-600 flex items-center gap-1">
                                <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                Online
                            </span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => navigator.clipboard.writeText(roomId)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-all" title="Copy Room ID"><Icon name="copy" size={20}/></button>
                            <button onClick={() => {setScreen('join'); setMessages([]);}} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-all" title="Leave"><Icon name="log-out" size={20}/></button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-50">
                        {messages.length === 0 && (
                            <div className="h-full flex flex-col items-center justify-center text-slate-400 space-y-2 opacity-60">
                                <Icon name="message-square" size={48} />
                                <p className="text-sm font-medium">No messages yet</p>
                            </div>
                        )}
                        {messages.map((msg, i) => {
                            const isMe = msg.uid === user.uid;
                            const showHeader = i === 0 || messages[i - 1].uid !== msg.uid;
                            return (
                                <div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'} ${showHeader ? 'mt-4' : 'mt-1'}`}>
                                    {showHeader && !isMe && <span className="text-[11px] text-slate-500 ml-3 mb-1 font-medium">{msg.displayName}</span>}
                                    <div className={`px-4 py-2 text-sm shadow-sm max-w-[85%] break-words ${isMe ? 'bg-blue-600 text-white rounded-2xl rounded-tr-sm' : 'bg-white text-slate-800 rounded-2xl rounded-tl-sm border border-gray-100'}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={messagesEndRef} />
                    </main>

                    <footer className="bg-white p-3 border-t pb-safe">
                        <form onSubmit={handleSendMessage} className="flex gap-2 items-center">
                            <input type="text" value={newMessage} onChange={e => setNewMessage(e.target.value)}
                                className="flex-1 bg-slate-100 text-slate-800 rounded-full px-5 py-3 outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-sm" placeholder="Type a message..." />
                            <button disabled={!newMessage.trim()} className="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:hover:bg-blue-600 transition-all transform active:scale-95"><Icon name="send" size={20}/></button>
                        </form>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>